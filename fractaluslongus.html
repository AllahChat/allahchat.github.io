<html>
<head>
	<script src="gpu-browser.min.js"></script>
	<script>
		function fractalUFO(cfgf,cfgg,width,height,mw,color) {
			let xs = [
				(mw[2] - mw[0]) * this.thread.x / width + mw[0],
				(mw[3] - mw[1]) * this.thread.y / height + mw[1]
			];

			let minz = 10000000;
			let mink = 0;
			let maxz = 0;
			let maxk = 0;
			
			for(let k = 0;k <= 10;++k) {
				xs = f(cfgf,xs);
				let zs = f(cfgg,xs);
				
				if(zs[0] * zs[0] + zs[1] * zs[1] < minz) {
					minz = zs[0] * zs[0] + zs[1] * zs[1];
					mink = k;
				}

				if(zs[0] * zs[0] + zs[1] * zs[1] > maxz) {
					maxz = zs[0] * zs[0] + zs[1] * zs[1];
					maxk = k;
				}
			}
			
			let mk = Math.max(mink,maxk);
			
			this.color(
				(Math.sin(0.05 * mk * 2.0 * Math.PI + color) + 1.0) / 2.0,
				(Math.sin(0.06 * mk * 2.0 * Math.PI + color) + 1.0) / 2.0,
				(Math.sin(0.07 * mk * 2.0 * Math.PI + color) + 1.0) / 2.0,
				1
			);
			
			return mk;
		}
		
		let gpu = new GPU();
		
		gpu.addFunction(function f(cfg,xs) {
			let x = 0;
			for(let i = 0;i < 3;++i) x += cfg[8 * i + 0] * Math.pow(xs[0],cfg[8 * i + 1]);
			for(let i = 3;i < 6;++i) x += cfg[8 * i + 2] * Math.pow(xs[1],cfg[8 * i + 3]);
			
			let y = 0;
			for(let i = 6;i < 9;++i) y += cfg[8 * i + 4] * Math.pow(xs[0],cfg[8 * i + 5]);
			for(let i = 9;i < 12;++i) y += cfg[8 * i + 6] * Math.pow(xs[1],cfg[8 * i + 7]);
			
			return [x,y];
		});

	</script>
</head>
<body>
	<script>
		let cfgf = new Float32Array(10000);
		for(let i = 0;i < cfgf.length;++i) cfgf[i] = Math.random() - 0.5;
		
		let cfgg = new Float32Array(10000);
		for(let i = 0;i < cfgg.length;++i) cfgg[i] = Math.random() - 0.5;
		
		let w = 512;
		let h = 512;		
		
		const kernel = gpu.createKernel(fractalUFO).setOutput([w,h]).setGraphical(true);
		const kernel2 = gpu.createKernel(fractalUFO).setOutput([w,h]);

		//console.log(kernel2(w,h,-10,-10,10,10,0)[0]);

		const cv = kernel.canvas;
		
		document.body.appendChild(cv);
		cv.style.width = "100%";
		cv.style.height = "100%";
		
		let pc = 1000000000;
		let pcfgf = cfgf.slice();
		let pcfgg = cfgg.slice();
		let pmathwindow = [-1,-1,1,1];
		let mathwindow = pmathwindow.slice();
		
		window.setInterval(() => {
			cfgf = pcfgf.slice();
			cfgg = pcfgg.slice();
			mathwindow = pmathwindow.slice();
			
			for(let i = 0;i < cfgf.length;++i) cfgf[i] += 0.01 * (Math.random() - 0.5);
			for(let i = 0;i < cfgg.length;++i) cfgg[i] += 0.01 * (Math.random() - 0.5);
			for(let i = 0;i < mathwindow.length;++i) mathwindow[i] += 0.1 * (Math.random() - 0.5);
			
			kernel(cfgf,cfgg,w,h,mathwindow,0);
			let xs = kernel2(cfgf,cfgg,w,h,mathwindow,0);
				
			//Coast Counter
			var c = 0;
			xs.forEach((ys) => {
			ys.forEach((y) => {
				if(y == 0 || y == 10 || y == 5) c++;
			});
			});
			
			c /= xs.length * xs[0].length;
			
			if(0.9 * c < pc) {
				pc = c;
				pcfgf = cfgf.slice();
				pcfgg = cfgg.slice();
				pmathwindow = mathwindow.slice();
			}
		},10);
	</script>
</body>
</html>




